---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  fig.width = 6,
  fig.height = 4
)
```

# ggbulksurv

<!-- badges: start -->
<!-- badges: end -->

The`ggbulksurv` package provides functions to facilitate bulk survival analysis, allowing users to input multiple observations per row.

**What is bulk survival analysis?** 

For some model organisms (eg _C. elegans_ and _D. melanogaster_), lifespan studies are usually performed in bulk. In bulk survival analysis, researchers place a certain number of organisms in a vial, and count the number of organisms that are dead/censored on any particular day. This produces a table that looks like this, with multiple observations per row:

condition | day | dead | censored
----      | --  | --   | ----
WT        | 10  | 2    | 0
WT        | 12  | 0    | 2
...

Unsurprisingly, survival analysis packages in R (eg `survival`, `survminer`) require each row to correspond to one individual. Wrangling the data manually is often a rather tedious task.

**What does this package do?**

`ggbulksurv` converts bulk survival data into individual observations per row, and plots a survival curve. Other functions are also available to plot mortality curves, customize colors, and to calculate relevant statistics such as median survival and log-rank tests.

`ggbulksurv` is very much under **active development**, and any feedback and contribution are welcome through the Issues page.

**Do I need this package?**

If you are conducting lifespan studies with _C.elegans_ and _D.melanogaster_ - probably. 


## Installation

Install the following dependencies from CRAN. If you use the `tidyverse`, these should already exist: 
``` r
install.packages(c("dplyr", "ggplot2", janitor", "magrittr", "methods", "scales", "tidyr"))
```

Install two other dependencies from Bioconductor: 
``` r
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install(c("survival", "survminer"))
```

You can install the development version of `ggbulksurv` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("qhuitan/ggbulksurv")
```

## Getting started (quick)

### 1. Read in your data with `read.csv()`. 

Your data file should be a `csv` with 4 columns: `condition`, `day`, `dead`, `censored`. Additional columns will be removed from the analysis. 

```{r setup}
library(ggbulksurv)

data(sample_data)
dat <- sample_data # load sample data

# If reading in a csv, use this code
#dat <- read.csv("/path-to-your-file/file.csv")

head(dat)
```


### 2. Run the survival analysis: 

`ggbulksurv` can be run with the default settings using the `run_bulksurv()` command: 

```{r survival}
# Plot a survival curve
p <- run_bulksurv(dat, 
                  sample_order = c("WT", "Drug1", "Drug2"), 
                  type = "survival")

p
```


```{r mortality}
# Plot a mortality curve
p <- run_bulksurv(dat, 
                  sample_order = c("WT", "Drug1", "Drug2"), 
                  type = "mortality",
                  print_stats = FALSE 
                  )

p
```

### Additional customizations

```{r surv_custom}
p <- run_bulksurv(dat, 
                  sample_order = c("WT", "Drug1", "Drug2"),
                  print_stats = FALSE,
                  palette = c("black", "red", "purple"), # Custom colors
                  legend.title = "",                     # Remove legend title
                  legend.position = c(0.9, 0.9),         # Position legend at top right
                  add.pval = TRUE                        # Add pvalue
             )

p
```

## Getting started (slower)

The `run_bulksurv()` command makes several choices for the user, with the caveat that these assumptions tend to hold under most conditions. Users who desire total control over the process should read this section for a more detailed walkthrough.

`run_bulksurv()` is a wrapper around the 3 following functions: 

1. `get_indiv_surv`: Converts a bulk survival table into an individual survival table.
2. `fit_surv`: Fits a survival object from `survival::survfit()`.
3. `plot_surv`: Plots a survival curve using `survminer::ggsurvplot()`.


This section takes you through the 3 steps that `run_bulksurv()` wraps around. 

### 1. Get individual survivals

`get_indiv_surv` converts a table of bulk survival data into individual survivals. Each row now represents an individual. `day` represents the number of days lived, while `status` is either 0 (censored) or 1 (dead). 


```{r}
df_isurv <- get_indiv_surv(sample_data,
                           sample_order = c("WT", "Drug1", "Drug2"))

head(df_isurv)
```

### 2. Fit the survival object

`fit_surv` takes in a `data.frame` generated by `get_indiv_surv()`, and creates a `survfit` object using the `survival::survfit()` function. 

```{r}
df_fit <- fit_surv(df_isurv)

head(df_fit)
```

Drug1 has the shortest median lifespan of 4.5 days, with a 95% confidence interval (95% CI) of 4 to 6 days. In contrast, Drug2 has the longest median lifespan of 33 days, with a 95% CI of 32 to 35 days.


### 3. Plot the survival object

```{r surv_detail}
plot_surv(fit = df_fit, type = "survival", data = df_isurv)
```

### 4. Print summary statistics

Calculates median survival, logrank test and pairwise logrank test with BH correction: 


```{r}
stats <- summary_stats(df_isurv, type = "all")

stats
```

This returns a list object, which allows us to individually pull out the values of interest. For example: 

The logrank test: 
```{r}
stats$logrank
```
```{r}
# chisq value of logrank test
stats$logrank$chisq
```


```{r}
# pvalue of logrank test
stats$logrank$pvalue
```

Pairwise test: 
```{r}
stats$pairwise
```
```{r}
# p-values
stats$pairwise$p.value
```


```{r}
sessionInfo()
```

